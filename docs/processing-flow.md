# 処理フロー

Step-Based Installer の処理構造を図解したドキュメント。

## 全体処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                      Install.bat 実行                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 事前チェック（Install.bat）                                  │
├─────────────────────────────────────────────────────────────────┤
│  ・管理者権限チェック → なければ昇格要求                         │
│  ・設定ファイル存在確認                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. PowerShellスクリプト実行                                     │
│     powershell -ExecutionPolicy Bypass -File Install-DevEnv.ps1 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 初期化（Install-DevEnv.ps1）                                 │
├─────────────────────────────────────────────────────────────────┤
│  ・モジュール読み込み (Common.ps1, StepHandlers.ps1)            │
│  ・設定JSON読み込み (config/tools.json)                         │
│  ・ログ初期化                                                    │
│  ・共有ディレクトリ接続確認                                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. ツールループ                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  for each tool in tools:                                        │
│      │                                                          │
│      └─▶ for each step in tool.steps:                          │
│              │                                                  │
│              ├─ type判定                                        │
│              ├─ Invoke-*Step 呼び出し                           │
│              │                                                  │
│              ├─ 成功 → 次のstepへ                               │
│              └─ 失敗 → 残りstepスキップ、次のtoolへ             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. サマリー出力                                                 │
├─────────────────────────────────────────────────────────────────┤
│  ・結果サマリー (成功/スキップ/失敗 件数)                        │
│  ・ログファイルパス表示                                          │
└─────────────────────────────────────────────────────────────────┘
```

## Stepタイプ別処理

### extract（7z/ZIP展開）

```
┌─────────────────────────────────────────┐
│         Invoke-ExtractStep              │
└─────────────────────────────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ 既に展開済み？   │     はい     ┌──────────┐
          │                 │────────────▶│ SKIPPED  │
          └─────────────────┘              └──────────┘
                    │ いいえ
                    ▼
          ┌─────────────────┐
          │ ソースファイル   │     なし     ┌──────────┐
          │ 存在確認        │────────────▶│ FAILED   │
          └─────────────────┘              └──────────┘
                    │ あり
                    ▼
          ┌─────────────────┐
          │ 拡張子判定       │
          │ .zip → Expand-Archive         │
          │ .7z  → 7z.exe                 │
          └─────────────────┘
                    │
                    ▼
               ┌──────────┐
               │ SUCCESS  │
               └──────────┘
```

### installer（サイレントインストール）

```
┌─────────────────────────────────────────┐
│       Invoke-InstallerStep              │
└─────────────────────────────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ インストーラ     │     なし     ┌──────────┐
          │ 存在確認        │────────────▶│ FAILED   │
          └─────────────────┘              └──────────┘
                    │ あり
                    ▼
          ┌─────────────────┐
          │ Start-Process   │
          │ -Wait で実行    │
          └─────────────────┘
                    │
                    ▼
               ┌──────────┐
               │ SUCCESS  │
               └──────────┘
```

### config（設定ファイル差し替え）

```
┌─────────────────────────────────────────┐
│        Invoke-ConfigStep                │
└─────────────────────────────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ ソースファイル   │     なし     ┌──────────┐
          │ 存在確認        │────────────▶│ FAILED   │
          └─────────────────┘              └──────────┘
                    │ あり
                    ▼
          ┌─────────────────┐
          │ 既存ファイルあり？│
          │ → .bak に退避   │
          └─────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ ファイルコピー   │
          └─────────────────┘
                    │
                    ▼
               ┌──────────┐
               │ SUCCESS  │
               └──────────┘
```

### env（環境変数設定）

```
┌─────────────────────────────────────────┐
│          Invoke-EnvStep                 │
└─────────────────────────────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ 既存値をログに   │
          │ バックアップ     │
          └─────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ action判定      │
          │ set → 上書き    │
          │ append → 追加   │
          └─────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ SetEnvironment  │
          │ Variable        │
          │ (Machine)       │
          └─────────────────┘
                    │
                    ▼
               ┌──────────┐
               │ SUCCESS  │
               └──────────┘
```

### cert（証明書登録）

```
┌─────────────────────────────────────────┐
│          Invoke-CertStep                │
└─────────────────────────────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ keystoreパス解決 │
          │ javaHome指定    │
          │ → lib\security\cacerts 付与  │
          └─────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │ 既に登録済み？   │     はい     ┌──────────┐
          │ (keytool -list) │────────────▶│ SKIPPED  │
          └─────────────────┘              └──────────┘
                    │ いいえ
                    ▼
          ┌─────────────────┐
          │ keytool         │
          │ -importcert     │
          └─────────────────┘
                    │
                    ▼
               ┌──────────┐
               │ SUCCESS  │
               └──────────┘
```

## ディレクトリ構成

```
package-management/
├── Install.bat                 # エントリーポイント
├── config/
│   └── tools.json              # ツール設定
├── scripts/
│   ├── Install-DevEnv.ps1      # メインスクリプト
│   └── lib/
│       ├── Common.ps1          # ログ、共通関数
│       └── StepHandlers.ps1    # 各タイプの処理関数
├── docs/
│   ├── processing-flow.md      # 本ドキュメント
│   └── plans/
└── logs/                       # 実行時に生成
```

## 処理結果ステータス

| ステータス | 意味 |
|------------|------|
| **SUCCESS** | 処理成功 |
| **SKIPPED** | 既にインストール済み等でスキップ |
| **FAILED** | 処理失敗 |

## エラーハンドリング

- step失敗時 → そのツールの残りstepをスキップ
- 次のツールは続行
- エラー内容はログに記録

## ログ出力

- **コンソール**: 色分け表示（緑=成功、黄=スキップ/警告、赤=失敗）
- **ファイル**: `{destBase}\logs\install-yyyyMMdd-HHmmss.log`

## 関連ドキュメント

- [Step-Based Installer 設計書](plans/2026-02-03-step-based-installer-design.md)
